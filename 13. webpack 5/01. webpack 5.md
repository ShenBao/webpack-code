# webpack 5

## åˆ é™¤ Node.js Polyfills

æ—©æœŸï¼Œwebpack çš„ç›®æ ‡æ˜¯å…è®¸åœ¨æµè§ˆå™¨ä¸­è¿è¡Œå¤§å¤šæ•° node.js æ¨¡å—ï¼Œä½†æ˜¯æ¨¡å—æ ¼å±€å‘ç”Ÿäº†å˜åŒ–ï¼Œè®¸å¤šæ¨¡å—ç”¨é€”ç°åœ¨ä¸»è¦æ˜¯ä¸ºå‰ç«¯ç›®çš„è€Œç¼–å†™çš„ã€‚webpack <= 4 é™„å¸¦äº†è®¸å¤š node.js æ ¸å¿ƒæ¨¡å—çš„ polyfillï¼Œä¸€æ—¦æ¨¡å—ä½¿ç”¨ä»»ä½•æ ¸å¿ƒæ¨¡å—ï¼ˆå³ crypto æ¨¡å—ï¼‰ï¼Œè¿™äº›æ¨¡å—å°±ä¼šè‡ªåŠ¨åº”ç”¨ã€‚

å°½ç®¡è¿™ä½¿ä½¿ç”¨ä¸º node.js ç¼–å†™çš„æ¨¡å—å˜å¾—å®¹æ˜“ï¼Œä½†å®ƒä¼šå°†è¿™äº›å·¨å¤§çš„ polyfill æ·»åŠ åˆ°åŒ…ä¸­ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™äº› polyfill æ˜¯ä¸å¿…è¦çš„ã€‚

webpack 5 ä¼šè‡ªåŠ¨åœæ­¢å¡«å……è¿™äº›æ ¸å¿ƒæ¨¡å—ï¼Œå¹¶ä¸“æ³¨äºä¸å‰ç«¯å…¼å®¹çš„æ¨¡å—ã€‚

è¿ç§»ï¼š

- å°½å¯èƒ½å°è¯•ä½¿ç”¨ä¸å‰ç«¯å…¼å®¹çš„æ¨¡å—ã€‚
- å¯ä»¥ä¸º node.js æ ¸å¿ƒæ¨¡å—æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª polyfillã€‚é”™è¯¯æ¶ˆæ¯å°†æç¤ºå¦‚ä½•å®ç°è¯¥ç›®æ ‡ã€‚

```txt
webpack 5 å¼€å§‹ä¸å†è‡ªåŠ¨å¡«å……è¿™äº› polyfillsï¼Œå¦‚æœä½ åœ¨webpack5ä¸­ä½¿ç”¨åˆ°äº†polyfillï¼š

ä½ çš„åº”ç”¨å°†ä¼šæŠ¥é”™ï¼Œå¦‚æœä½ ç¡®å®æ˜¯è¦æ˜¯è¦è¿™äº›æ¨¡å—ï¼Œæ§åˆ¶å°ä¸­ä¹Ÿç»™ä½ æä¾›äº†è§£å†³çš„æ–¹æ¡ˆï¼ŒæŒ‰ç…§æ§åˆ¶å°çš„æç¤ºå»å®‰è£…å¯¹åº”çš„åŒ…å’Œæ·»åŠ å¯¹åº”çš„é…ç½®å°±å¯ä»¥äº†ã€‚
```

```js
new webpack.ProvidePlugin({
  Buffer: ['buffer', 'Buffer'],
});
```

## Output

webpack 4 é»˜è®¤åªèƒ½è¾“å‡º ES5 ä»£ç 

webpack 5 å¼€å§‹æ–°å¢ä¸€ä¸ªå±æ€§ output.ecmaVersion, å¯ä»¥ç”Ÿæˆ ES5 å’Œ ES6 / ES2015 ä»£ç .

å¦‚ï¼š`output.ecmaVersion: 2015`

## outputModule æ˜¯å•¥ï¼Ÿ

- outputModuleï¼š true
- output.libraryTargetï¼šmodule

é‚£ä¹ˆè®¾ç½® outputModule ä¸º true ä»¥åå’Œä¸è®¾ç½®çš„åŒºåˆ«åœ¨å“ªå‘¢ï¼Ÿå¦‚åå­—æ‰€ç¤ºä¸¢æ‰äº†é—­åŒ…æŠŠè‡ªå·±å˜æˆäº† module

## SplitChunkï¼šminSize&maxSize æ›´å¥½çš„æ–¹å¼è¡¨è¾¾

åœ¨ V4 ç‰ˆæœ¬ä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œä»…èƒ½å¤„ç† javascript çš„å¤§å°

```js
// webpack4
minSize: 30000;
```

V5 ç‰ˆæœ¬çš„å˜æ›´ï¼Œå·²ç»æ”¯æŒäº† styleã€‚

```js
// webpack5
minSize: {
  javascript: 30000,
  style: 50000,
}
```

```js
module.exports = {
  optimization: {
    splitChunks: {
      cacheGroups: {
        commons: {
          chunks: 'all',
          name: 'commons',
        },
      },
      //æœ€å°çš„æ–‡ä»¶å¤§å° è¶…è¿‡ä¹‹åå°†ä¸äºˆæ‰“åŒ…
      minSize: {
        javascript: 0,
        style: 0,
      },
      //æœ€å¤§çš„æ–‡ä»¶ è¶…è¿‡ä¹‹åç»§ç»­æ‹†åˆ†
      maxSize: {
        javascript: 1, //æ•…æ„å†™å°çš„æ•ˆæœæ›´æ˜æ˜¾
        style: 3000,
      },
    },
  },
};
```

## æŒä¹…åŒ–ç¼“å­˜ Cache

Webpack çš„ç¼–è¯‘é€Ÿåº¦ç›¸ä¿¡æ˜¯å¾ˆå¤šåŒå­¦æ¯”è¾ƒå¤´ç—›çš„é—®é¢˜ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæœ‰å¾ˆå¤šä¼˜åŒ–çš„åŠæ³•ã€‚æ¯”å¦‚ HappyPackã€Cache-loaderã€æ’é™¤ node_modulesã€å¤šçº¿ç¨‹å‹ç¼©ç”šè‡³å¯ä»¥é‡‡ç”¨åˆ†å¸ƒå¼ç¼–è¯‘ç­‰ç­‰ã€‚å…¶å® Webpack ç¼–è¯‘æ…¢è¿˜è·Ÿä»–çš„ loder æœºåˆ¶æœ‰ä¸€å®šå…³ç³»ã€‚

```js
// é…ç½®ç¼“å­˜
cache: {
  // ç£ç›˜å­˜å‚¨
  type: "filesystem", //å°†ç¼“å­˜ç±»å‹è®¾ç½®ä¸ºæ–‡ä»¶ç³»ç»Ÿï¼Œé»˜è®¤ä¸ºmemory
  buildDependencies: {
    // å½“é…ç½®ä¿®æ”¹æ—¶ï¼Œç¼“å­˜å¤±æ•ˆ
    config: [__filename]
  }
}
```

ç¼“å­˜å°†å­˜å‚¨åˆ° `node_modules/.cache/webpack`

## Top Level Await

topLevelAwait æ”¯æŒé¡¶çº§ Await Stage 3 ææ¡ˆ

webpack.config.js

```js
module.exports = {
  experiments: {
    // å¯¼å…¥å¼‚æ­¥æ¨¡å— import webpackä¼šæç¤ºä½ æ‰“å¼€è¿™ä¸ªå±æ€§
    importAsync: true,
    // å…¨é å®ƒäº†topLevelAwait
    topLevelAwait: true,
  },
};
```

test.js

```js
const dynamic = await import('./data');
export const output = dynamic.default + 'test';
```

è¿›ä¸€æ­¥ï¼š

test.js

```js
const connectToDB = async () => {
  const data = await new Promise((r) => {
    r('test');
  });
  return data;
};
const result = await connectToDB();
let output = `${result}ğŸŠ`;
export { output };

//æ‰§è¡Œå¦‚ä¸‹ä»£ç 
import await { output } from './demo02';
console.log(output);
```

webpack.config.js

```js
// ä¸‰å…„å¼Ÿèšé½äº†
module.exports = {
  experiments: {
    importAsync: true,
    topLevelAwait: true,
    // æ”¯æŒimport await
    importAwait: true,
  },
};
```

## å†è§äº† file-loaderã€url-loaderã€raw-loader

å¯¹èµ„æºæ¨¡å—æä¾›äº†å†…ç½®æ”¯æŒï¼Œwebpack5 å…è®¸åº”ç”¨ä½¿ç”¨èµ„æºæ–‡ä»¶ï¼ˆå›¾ç‰‡ï¼Œå­—ä½“ç­‰)è€Œä¸éœ€è¦é…ç½®é¢å¤–çš„ loaderã€‚

- asset/resource å‘é€ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¹¶å¯¼å‡º URLã€‚ä¹‹å‰é€šè¿‡ä½¿ç”¨ file-loader å®ç°ã€‚
- asset/inline å¯¼å‡ºä¸€ä¸ªèµ„æºçš„ data URIã€‚ä¹‹å‰é€šè¿‡ä½¿ç”¨ url-loader å®ç°ã€‚
- asset/source å¯¼å‡ºèµ„æºçš„æºä»£ç ã€‚ä¹‹å‰é€šè¿‡ä½¿ç”¨ raw-loader å®ç°ã€‚
- asset åœ¨å¯¼å‡ºä¸€ä¸ª data URI å’Œå‘é€ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¹‹é—´è‡ªåŠ¨é€‰æ‹©ã€‚ä¹‹å‰é€šè¿‡ä½¿ç”¨ url-loaderï¼Œå¹¶ä¸”é…ç½®èµ„æºä½“ç§¯é™åˆ¶å®ç°ã€‚

```js
module.exports = {
  output: {
    assetModuleFilename: 'images/[name].[hash:5][ext]',
  },
  module: {
    rules: [
      {
        test: /\.png$/,
        type: 'asset/resource', //å¯¹åº”file-loader
      },
      {
        test: /\.svg$/,
        type: 'asset/inline', //å¯¹åº”url-loader å¤§å°<limt è½¬åŒ–ä¸ºbase64
      },
      {
        test: /\.txt$/,
        type: 'asset/source', //å¯¹åº”raw-loader
      },
      {
        test: /\.gif$/,
        type: 'asset', //è‡ªåŠ¨é€‰æ‹©
        parser: {
          dataUrlCondition: {
            maxSize: 4 * 1024,
          },
        },
      },
    ],
  },
  experiments: {
    asset: true,
  },
};
```

## å†…ç½® WebAssembly ç¼–è¯‘èƒ½åŠ›

```c
//ä¸€æ®µéå¸¸ç®€å•çš„Cä»£ç 
int add (int x, int y) {
  return x + y;
}
//ç„¶åæˆ‘ä»¬æŠŠå®ƒç¼–è¯‘æˆprogram.wasm
```

```js
//webpack4åªèƒ½è¿™æ ·å»åŠ è½½program.wasm
//å¦‚æœåŒæ­¥å»åŠ è½½ ä¼šæŠ¥é”™ä¸èƒ½æŠŠwasmå½“æˆä¸»chunk
import('./demo04/program.wasm').then((p) => {
  console.log(p.add(4, 6));
});
//webpack5éœ‡æ’¼æ¥è¢­
//æœ‰äººè¯´WebAssemblyè¿™ç©æ„ä¹Ÿæ²¡äººç”¨å•Šï¼Ÿé‚£å•¥ ğŸ› æ™šå®‰
import {add} from './demo03/program';
console.log(add(4, 6));
```

ç»§ç»­ä¿®æ”¹ webpack.config.js

```js
module.exports = {
  // ...,
  experiments: {
    asyncWebAssembly: true,
  },
  module: {
    rules: [
      {
        test: /\.wasm$/,
        type: 'webassembly/async',
      },
    ],
  },
};
```

## mjs ç¼–è¯‘

```js
const data = 'test data';
export default data;

//è¿è¡Œä¸€ä¸‹ä»£ç 
import data from './demo';
console.log(data);
```

ä¿®æ”¹ webpack.config.js

```js
module.exports = {
  experiments: {
    mjs: true,
  },
};
```

## åŸç”Ÿ Web Worker æ”¯æŒ

ä»¥å‰æƒ³è¦ä½¿ç”¨ web workerï¼Œé‚£ä¹ˆéœ€è¦ worker-loader æˆ– worker-plugin æ¥ååŠ©ï¼š

```js
//é…ç½®worker-loader
module.exports = {
    // ...,
	module: {
		rules: [
			{
				test: /\.worker\.js$/,
				use: { loader: "worker-loader" },
			},
		],
	},
}
```

```js
import Worker from './wasted.time.worker.js';
//åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨web worker
const worker = new Worker();
worker.onmessage = (e) => {
  console.log(e.data.value);
};
```

webpack5 æä¾›äº†åŸç”Ÿçš„ web worker æ”¯æŒï¼Œå¯ä»¥ä¸ä¾èµ– loader æˆ– pluginï¼Œç›´æ¥ä½¿ç”¨ web worker çš„èƒ½åŠ›ï¼š

```js
const worker = new Worker(new URL('./wasted.time.worker.js', import.meta.url), {
  name: 'wastedTime',
  /* webpackEntryOptions: { filename: "workers/[name].js" } */
});
worker.onmessage = (e) => {
  console.log(e.data.value);
};
```

## æ›´å‹å¥½çš„ Long Term Cache æ”¯æŒæ€§

### ç¡®å®šçš„ moduleId å’Œ chunkId

webpack5 ä¹‹å‰çš„ç‰ˆæœ¬çš„ moduleId å’Œ chunkId é»˜è®¤æ˜¯è‡ªå¢çš„ï¼Œæ²¡æœ‰ä» entry æ‰“åŒ…çš„ chunk éƒ½ä¼šä»¥ 1ã€2ã€3ã€4...çš„é€’å¢å½¢å¼çš„æ–‡ä»¶å‘½åæ–¹å¼è¿›è¡Œå‘½åã€‚å¦‚æœåˆ æ‰æŸä¸€ä¸ªï¼Œåˆ™åé¢çš„ chunkId éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼›

webpack5 ä¸ºäº†ç¡®ä¿ moduleIdï¼ŒchunkId çš„ç¡®å®šæ€§ï¼Œæ·»åŠ äº†ç”¨äºé•¿æœŸç¼“å­˜çš„æ–°ç®—æ³•ï¼Œ å¢åŠ äº†å¦‚ä¸‹é…ç½®ï¼ˆæ­¤é…ç½®åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹æ˜¯é»˜è®¤å¼€å¯ï¼‰ï¼š

```js
optimization.moduleIds = 'deterministic';
optimization.chunkIds = 'deterministic';
```

### webpackChunkName

å½“åœ¨ index.js å†…éƒ¨ import(./async.js").then(...)çš„æ—¶å€™ï¼Œå¦‚æœä»€ä¹ˆä¹Ÿä¸åŠ ã€‚V4 ä¼šé»˜è®¤å¯¹è¿™äº›æ–‡ä»¶ç”Ÿæˆä¸€å † 0.js,1.js,2.jsâ€¦ .æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ import(/_ webpackChunkName: "name" _/ "module") æ‰èƒ½åŒ–è§£è¿™ä»½å°´å°¬ã€‚V5 å¯ä»¥åœ¨å¼€å‘æ¨¡å¼ä¸­å¯ç”¨äº†ä¸€ä¸ªæ–°å‘½åçš„å— id ç®—æ³•ï¼Œè¯¥ç®—æ³•æä¾›å—(ä»¥åŠæ–‡ä»¶å)å¯è¯»çš„å¼•ç”¨ã€‚ æ¨¡å— ID ç”±å…¶ç›¸å¯¹äºä¸Šä¸‹æ–‡çš„è·¯å¾„ç¡®å®šã€‚ å— ID æ˜¯ç”±å—çš„å†…å®¹å†³å®šçš„ï¼Œæ‰€ä»¥ä¸å†éœ€è¦ä½¿ç”¨ Magic Commentsã€‚

ä½ å¯ä»¥ä¸ç”¨ä½¿ç”¨ `import(/* webpackChunkName: "name" */ "module")` åœ¨å¼€å‘ç¯å¢ƒæ¥ä¸º chunk å‘½åï¼Œç”Ÿäº§ç¯å¢ƒè¿˜æ˜¯æœ‰å¿…è¦çš„

webpack å†…éƒ¨æœ‰ chunk å‘½åè§„åˆ™ï¼Œä¸å†æ˜¯ä»¥ id(0, 1, 2)å‘½åäº†

### çœŸå®çš„ content hash

å½“ä½¿ç”¨ [contenthash] æ—¶ï¼ŒWebpack 5 å°†ä½¿ç”¨çœŸæ­£çš„æ–‡ä»¶å†…å®¹å“ˆå¸Œå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´å½“è¿›è¡Œäº†ä¿®æ”¹æ³¨é‡Šæˆ–è€…ä¿®æ”¹å˜é‡åç­‰ä»£ç é€»è¾‘æ˜¯æ²¡æœ‰å½±å“çš„æ“ä½œæ˜¯ï¼Œæ–‡ä»¶å†…å®¹çš„å˜æ›´ä¸ä¼šå¯¼è‡´ contenthash å˜åŒ–ã€‚

## ä¼˜åŒ–èµ„æºæ‰“åŒ…ç­–ç•¥

prepack èƒ½å¤Ÿåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°†ä¸€äº›æ— å‰¯ä½œç”¨çš„å‡½æ•°çš„ç»“æœæå‰è®¡ç®—å‡ºæ¥ã€‚

webpack5 å†…ç½®äº†è¿™ç§èƒ½åŠ›ï¼Œèƒ½å¤Ÿè®©ä½ çš„åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¾—åˆ°æè‡´çš„ä¼˜åŒ–ã€‚

```js
//å…¥å£æ–‡ä»¶
(function () {
  function hello() {
    return 'hello';
  }
  function world() {
    return 'world';
  }
  global.s = hello() + ' ' + world();
})();
```

æœ€ç»ˆï¼š

```js
global.s = â€œhello worldâ€;
```

## æ›´å¼ºå¤§çš„ Tree Shaking

tree-shaking èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åœ¨æ‰“åŒ…çš„æ—¶å€™å‰”é™¤æ— ç”¨çš„ä»£ç ã€‚webpack5 å¼€å¯ tree-shaking çš„æ¡ä»¶ä¸ä¹‹å‰ä¸€æ ·ï¼Œéœ€è¦ä½¿ç”¨ ES6 æ¨¡å—åŒ–ï¼Œå¹¶å¼€å¯ production ç¯å¢ƒã€‚

1. webpack ç°åœ¨èƒ½å¤Ÿå¤„ç†å¯¹åµŒå¥—æ¨¡å—çš„ tree shaking

```js
// inner.js
export const a = 1;
export const b = 2;

// module.js
import * as inner from './inner';
export {inner};

// user.js
import * as module from './module';
console.log(module.inner.a);
```

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­, inner æ¨¡å—æš´éœ²çš„ `b` ä¼šè¢«åˆ é™¤

2. webpack ç°åœ¨èƒ½å¤Ÿå¤šä¸ªæ¨¡å—ä¹‹å‰çš„å…³ç³»

```js
import {something} from './something';

function usingSomething() {
  return something;
}

export function test() {
  return usingSomething();
}
```

å½“è®¾ç½®äº†`"sideEffects": false`æ—¶ï¼Œä¸€æ—¦å‘ç°`test`æ–¹æ³•æ²¡æœ‰ä½¿ç”¨ï¼Œä¸ä½†åˆ é™¤`test`ï¼Œè¿˜ä¼šåˆ é™¤`"./something"`

3. webpack ç°åœ¨èƒ½å¤„ç†å¯¹ Commonjs çš„ tree shaking

webpack5 åˆ†ææ¨¡å—çš„ export å’Œ import çš„ä¾èµ–å…³ç³»ï¼Œå»æ‰æœªè¢«ä½¿ç”¨çš„æ¨¡å—ï¼ŒåŒæ—¶ç»“åˆ prepack èƒ½åŠ›ï¼Œæ‰“åŒ…å‡ºæ¥çš„ç»“æœååˆ†ç®€æ´

## ç›‘è§†è¾“å‡ºæ–‡ä»¶

ä¹‹å‰ webpack æ€»æ˜¯åœ¨ç¬¬ä¸€æ¬¡æ„å»ºæ—¶è¾“å‡ºå…¨éƒ¨æ–‡ä»¶ï¼Œä½†æ˜¯ç›‘è§†é‡æ–°æ„å»ºæ—¶ä¼šåªæ›´æ–°ä¿®æ”¹çš„æ–‡ä»¶ã€‚

æ­¤æ¬¡æ›´æ–°åœ¨ç¬¬ä¸€æ¬¡æ„å»ºæ—¶ä¼šæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶çœ‹æ˜¯å¦æœ‰å˜åŒ–ï¼Œä»è€Œå†³å®šè¦ä¸è¦è¾“å‡ºå…¨éƒ¨æ–‡ä»¶ã€‚

## é»˜è®¤å€¼

- `entry: "./src/index.js`
- `output.path: path.resolve(__dirname, "dist")`
- `output.filename: "[name].js"`

![webpack-v5.PNG](../img/webpack-v5.PNG)

## æ›´å¤šå†…å®¹

- change logsï¼šhttps://webpack.docschina.org/blog/2020-10-10-webpack-5-release/
- Module Federationï¼šhttps://webpack.docschina.org/concepts/module-federation
- è¿ç§»æŒ‡å—ï¼šhttps://webpack.docschina.org/migrate/5/
